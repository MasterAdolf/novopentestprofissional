# Tracking the route

Vamos aprender como identificar informações de rotas até o nosso alvo.

Vamos identificar a rota que o pacote faz desde a nossa máquina até chegar no nosso alvo, e quais tipos de protocolos (TCP, UDP, ICMP, etc) são aceitos.

Normalmente o pacote sai da nossa máquina, vai para o nosso roteador, passa pelo nosso provedor. Segue caminhando por vários roteadores até chegar na máquina alvo. Nesse caminho podemos nos deparar com filtros , bloqueios, que é interessantes identificarmos.

É interessante revisar a aula "Entendendo o TTL" do módulo "TCP/IP para Pentesters".

Iniciamos enviando 01 (um) pacote para o alvo:

```bash
$ ping businesscorp.com.br -c 1
PING businesscorp.com.br (37.59.174.225) 56(84) bytes of data.
64 bytes from ip225.ip-37-59-174.eu (37.59.174.225): icmp_seq=1 ttl=48 time=177 ms

--- businesscorp.com.br ping statistics ---
1 packets transmitted, 1 received, 0% packet loss, time 0ms
rtt min/avg/max/mdev = 177.630/177.630/177.630/0.000 ms
```



No comando acima ele retornou o TTL = 48, ou seja tudo indica que o sistema é Linux, pois está mais perto do 64 padrão do Linux, e a diferença (16) é a quantidade de equipamentos que o pacote passou entre a nossa máquina e o alvo (businesscorp.com.br). Pois sempre que o pacote passa por um roteador o número inicial do TTL é decrementado em 1.

**TTL padrão** dos sistemas:

* 64 - Linux 

* 128 - Windows



OBS: Esses números padrões podem ser alterados nas configurações dos sistemas operacionais.



Podemos manipular o TTL no ping com o parâmetro "-t". No exemplo abaixo estamos enviando um pacote com o TTL = 1.

``` bash
$ ping businesscorp.com.br -c 1 -t 1                                                                                     
PING businesscorp.com.br (37.59.174.225) 56(84) bytes of data.
From _gateway (192.168.0.1) icmp_seq=1 Time to live exceeded

--- businesscorp.com.br ping statistics ---
1 packets transmitted, 0 received, +1 errors, 100% packet loss, time 0ms
```

Recebemos uma resposta "Time to live exceeded". Pois depois que ele passa pelo primeiro roteador (192.168.0.1) o TTL fica igual a zero e esse roteador descarta o mesmo, não passa ele para o próximo roteador.

Se definirmos o "-t 2" o pacote chega até o segundo roteador, conforme abaixo:
``` bash
$ ping businesscorp.com.br -c 1 -t 2
PING businesscorp.com.br (37.59.174.225) 56(84) bytes of data.
From 100.94.128.1 (100.94.128.1) icmp_seq=1 Time to live exceeded

--- businesscorp.com.br ping statistics ---
1 packets transmitted, 0 received, +1 errors, 100% packet loss, time 0ms
```

Recebemos uma resposta "Time to live exceeded". Pois depois que ele passa pelo segundo roteador (100.94.128.1) o TTL fica igual a zero e esse roteador descarta o mesmo, não passa ele para o próximo roteador.



Podemos utilizar o utilitário ***traceroute*** para "trackear" a rota. Vamos testar da nossa maquina até o facebook.com:

``` bash
$ traceroute facebook.com
traceroute to facebook.com (31.13.74.35), 30 hops max, 60 byte packets
 1  _gateway (192.168.0.1)  0.230 ms  0.218 ms  0.252 ms
 2  100.94.128.1 (100.94.128.1)  5.051 ms  5.221 ms  5.436 ms
 3  172.16.134.221 (172.16.134.221)  11.123 ms  11.121 ms  11.190 ms
 4  172.16.128.49 (172.16.128.49)  11.109 ms  11.111 ms  11.229 ms
 5  172.16.128.134 (172.16.128.134)  10.838 ms  10.561 ms  10.820 ms
 6  172.16.130.2 (172.16.130.2)  10.400 ms  10.298 ms  10.126 ms
 7  172.16.127.57 (172.16.127.57)  9.781 ms  10.577 ms  10.484 ms
 8  * * 100.64.4.77 (100.64.4.77)  10.160 ms
 9  172.16.127.5 (172.16.127.5)  12.109 ms  12.049 ms  11.999 ms
10  172.16.128.97 (172.16.128.97)  22.039 ms  21.950 ms  21.945 ms
11  172.16.128.57 (172.16.128.57)  20.952 ms  21.934 ms  22.697 ms
12  172.16.128.185 (172.16.128.185)  21.692 ms  21.632 ms  21.553 ms
13  8.243.156.205 (8.243.156.205)  24.435 ms  24.470 ms  24.417 ms
14  ae1.3501.edge1.RiodeJaneiro1.level3.net (4.69.215.6)  67.542 ms  67.494 ms  71.412 ms
15  ae1.pr01.gig2.tfbnw.net (157.240.73.58)  72.407 ms  68.343 ms  72.386 ms
16  po101.psw03.gig2.tfbnw.net (157.240.42.207)  68.340 ms po101.psw02.gig2.tfbnw.net (204.15.20.71)  68.553 ms po101.psw04.gig2.tfbnw.net (157.240.45.201)  68.474 ms
17  157.240.38.153 (157.240.38.153)  67.926 ms 173.252.67.135 (173.252.67.135)  67.881 ms 157.240.38.131 (157.240.38.131)  66.797 ms
18  edge-star-mini-shv-01-gig2.facebook.com (31.13.74.35)  67.887 ms  67.815 ms  68.649 ms
```

O retorno do comando acima mostra todos os roteadores por onde o pacote passou.

Ele inicia mostrando o IP do businesscorp.com.br, e informa que vai executar 30 saltos (hops) , que é o número padrão do traceroute:

```bash
facebook.com (31.13.74.35), 30 hops max,
```

Podemos verificar que nas linhas 16 e 17, temos um balanceamento de carga, pois estamos vendo três IPs para cada rota: 

```bash
16  po101.psw03.gig2.tfbnw.net (157.240.42.207)  68.340 ms po101.psw02.gig2.tfbnw.net (204.15.20.71)  68.553 ms po101.psw04.gig2.tfbnw.net (157.240.45.201)  68.474 ms
17  157.240.38.153 (157.240.38.153)  67.926 ms 173.252.67.135 (173.252.67.135)  67.881 ms 157.240.38.131 (157.240.38.131)  66.797 ms
```

Em alguns casos , como na linha 8, ele mostra um "*". Quando o alvo demora mais de três segundos para responder ele sinaliza isso com um asterisco (\*):

```bash
8  * * 100.64.4.77 (100.64.4.77)  10.160 ms
```

Outro caso é quando temos na linha três asteriscos, isso indica que o host não responde ao protocolo que esta sendo utilizado pelo comando traceroute, no exemplo acima não tivemos nenhum caso desse tipo. Por padrão ele funciona com o protocolo UDP.

Podemos manipular o tempo de resposta do comando com o parametro "-w". No exemplo abaixo temos o tempo de resposta setado em 1 (um) segundo:

``` 
$ traceroute facebook.com -w 1
```



Com o parãmetro "-m" podemos indicar a quantidade de "hops", se setarmos o valor "1" ele só vai até o primeiro roteador, como mostramos anteriormente usando o comando "ping":

``` bash
$ traceroute facebook.com -m 1
traceroute to facebook.com (31.13.74.35), 1 hops max, 60 byte packets
 1  _gateway (192.168.0.1)  0.250 ms  0.237 ms  0.287 ms
```



Usando o parâmetro "-f" informamos a partir de qual salto queremos continuar , no exemplo abaixo definimos 10 (dez) saltos (hops), mas ele vai iniciar a partir do quinto salto:

```bash
$ traceroute facebook.com -m 10 -f 5
traceroute to facebook.com (157.240.216.35), 10 hops max, 60 byte packets
 5  172.16.128.134 (172.16.128.134)  10.468 ms  10.492 ms  10.508 ms
 6  172.16.130.2 (172.16.130.2)  10.280 ms  10.200 ms  10.164 ms
 7  172.16.127.57 (172.16.127.57)  10.210 ms  10.292 ms  10.251 ms
 8  * * 100.64.4.77 (100.64.4.77)  10.336 ms
 9  172.16.127.5 (172.16.127.5)  13.289 ms  13.253 ms  13.293 ms
10  172.16.128.97 (172.16.128.97)  22.312 ms  22.131 ms  22.054 ms
```

Conseguimos dessa forma otimizar a saida da ferramenta para o que queremos mapear.

Utilizando o parâmetro "-A" o comando exibe os  autonomous system (AS) de todas as rotas por onde o pacote passar:

```bash
$ traceroute facebook.com -m 20 -f 8 -A
traceroute to facebook.com (31.13.74.35), 20 hops max, 60 byte packets
 8  * * 100.64.4.77 (100.64.4.77) [*]  11.052 ms
 9  172.16.127.5 (172.16.127.5) [*]  13.049 ms  13.016 ms  12.963 ms
10  172.16.128.97 (172.16.128.97) [*]  22.184 ms  22.098 ms  22.896 ms
11  172.16.128.57 (172.16.128.57) [*]  21.979 ms  21.989 ms  22.101 ms
12  172.16.128.185 (172.16.128.185) [*]  21.890 ms  21.844 ms  21.846 ms
13  8.243.156.205 (8.243.156.205) [AS3356]  21.964 ms  20.995 ms  20.956 ms
14  ae1.3501.edge1.RiodeJaneiro1.level3.net (4.69.215.6) [AS3356]  67.078 ms  67.937 ms  67.037 ms
15  ae1.pr01.gig2.tfbnw.net (157.240.73.58) [AS32934]  68.142 ms  68.144 ms  68.049 ms
16  po101.psw01.gig2.tfbnw.net (31.13.25.31) [AS32934]  67.927 ms  67.925 ms  67.858 ms
17  173.252.67.181 (173.252.67.181) [AS32934]  67.948 ms 173.252.67.15 (173.252.67.15) [AS32934]  68.054 ms 157.240.38.153 (157.240.38.153) [AS32934]  68.084 ms
18  edge-star-mini-shv-01-gig2.facebook.com (31.13.74.35) [AS32934]  67.007 ms  68.984 ms  67.774 ms
```



Usando o parâmetro "-n" ele não exibe o host, abaixo temos uma saída sem o "-n" e a seguinte usando o "-n":

```bash
$ traceroute facebook.com -m 20 -f 15
traceroute to facebook.com (31.13.74.35), 20 hops max, 60 byte packets
15  ae1.pr01.gig2.tfbnw.net (157.240.73.58)  68.731 ms  68.642 ms  68.680 ms
16  po101.psw03.gig2.tfbnw.net (157.240.42.207)  67.510 ms po101.psw01.gig2.tfbnw.net (31.13.25.31)  68.384 ms  68.530 ms
17  173.252.67.65 (173.252.67.65)  69.440 ms 157.240.38.247 (157.240.38.247)  68.369 ms 173.252.67.59 (173.252.67.59)  68.372 ms
18  edge-star-mini-shv-01-gig2.facebook.com (31.13.74.35)  69.376 ms  68.425 ms  68.349 ms

$ traceroute facebook.com -m 20 -f 15  -n
traceroute to facebook.com (31.13.74.35), 20 hops max, 60 byte packets
15  157.240.73.58  75.462 ms  75.383 ms  75.327 ms
16  157.240.45.201  68.435 ms 31.13.25.31  68.283 ms 157.240.42.207  68.234 ms
17  157.240.38.237  68.332 ms 173.252.67.57  68.437 ms 157.240.38.247  68.238 ms
18  31.13.74.35  67.395 ms  68.082 ms  67.277 ms
```



Se utilziarmos o parâmetro "-I" o traceroute usa o protocolo ICMP para fazer o mapeamento:

```bash
$ sudo traceroute facebook.com -I
traceroute to facebook.com (31.13.74.35), 30 hops max, 60 byte packets
 1  _gateway (192.168.0.1)  0.163 ms  0.197 ms  0.255 ms
 2  100.94.128.1 (100.94.128.1)  3.976 ms  4.243 ms  4.466 ms
 3  172.16.134.221 (172.16.134.221)  10.975 ms  10.987 ms  11.071 ms
 4  172.16.128.49 (172.16.128.49)  10.983 ms  11.047 ms  11.209 ms
 5  172.16.128.134 (172.16.128.134)  10.550 ms  10.624 ms  10.719 ms
 6  172.16.130.2 (172.16.130.2)  10.360 ms  10.031 ms  9.522 ms
 7  172.16.127.57 (172.16.127.57)  10.008 ms  10.031 ms  10.032 ms
 8  100.64.4.77 (100.64.4.77)  10.595 ms * *
 9  172.16.127.5 (172.16.127.5)  12.586 ms  12.600 ms  12.600 ms
10  172.16.128.97 (172.16.128.97)  22.516 ms  22.529 ms  22.529 ms
11  172.16.128.57 (172.16.128.57)  21.564 ms  21.580 ms  22.502 ms
12  172.16.128.185 (172.16.128.185)  21.082 ms  20.657 ms  20.644 ms
13  8.243.156.205 (8.243.156.205)  20.635 ms  21.717 ms  21.686 ms
14  ae1.3501.edge1.RiodeJaneiro1.level3.net (4.69.215.6)  68.747 ms  68.705 ms  68.704 ms
15  ae1.pr01.gig2.tfbnw.net (157.240.73.58)  88.664 ms  88.687 ms  89.638 ms
16  po101.psw01.gig2.tfbnw.net (31.13.25.31)  68.642 ms  68.659 ms  68.656 ms
17  157.240.38.69 (157.240.38.69)  67.726 ms  67.679 ms  67.676 ms
18  edge-star-mini-shv-01-gig2.facebook.com (31.13.74.35)  67.601 ms  67.635 ms  67.846 ms
```



Ainda podemos utilizar o parâmetro "-T" para que o traceroute utilize o protocolo TCP, a porta padrão de envio é a "80":

``` bash
$ sudo traceroute facebook.com -T -n
traceroute to facebook.com (31.13.74.35), 30 hops max, 60 byte packets
 1  192.168.0.1  0.383 ms  0.165 ms  0.201 ms
 2  100.94.128.1  5.016 ms  5.166 ms  5.366 ms
 3  172.16.134.221  10.551 ms  10.561 ms  10.569 ms
 4  172.16.128.49  10.650 ms  10.615 ms  10.812 ms
 5  172.16.128.134  10.369 ms  11.534 ms  11.762 ms
 6  172.16.130.2  11.322 ms  11.265 ms  11.198 ms
 7  172.16.127.57  11.210 ms  9.742 ms  9.632 ms
 8  100.64.4.77  11.108 ms * *
 9  172.16.127.5  12.057 ms  12.115 ms  12.070 ms
10  172.16.128.97  22.201 ms  22.041 ms  21.757 ms
11  172.16.128.57  22.757 ms  21.732 ms  21.714 ms
12  172.16.128.185  21.505 ms  21.264 ms  21.326 ms
13  8.243.156.205  21.254 ms  20.807 ms  20.869 ms
14  4.69.215.6  68.864 ms  68.923 ms  70.569 ms
15  157.240.73.58  71.381 ms  71.390 ms  71.378 ms
16  31.13.25.31  68.309 ms  68.326 ms  68.321 ms
17  157.240.38.197  66.752 ms 157.240.38.223  67.995 ms 173.252.67.127  67.852 ms
18  * * *
19  31.13.74.35  68.134 ms  68.678 ms  67.655 ms
```



Podemos verificar a diferença em usar o protocolo ICMP e o TCP. Usando como exemplo o alvo. Incialmente usando o ICMP e ele não chega no alvo:

``` bash
$ sudo traceroute www.ati.pe.gov.br -I -n
traceroute to www.ati.pe.gov.br (200.238.107.80), 30 hops max, 60 byte packets
 1  192.168.0.1  0.169 ms  0.202 ms  0.262 ms
 2  100.94.128.1  4.067 ms  4.241 ms  4.463 ms
 3  172.16.134.221  10.880 ms  10.889 ms  11.039 ms
 4  172.16.128.49  11.219 ms  11.366 ms  11.382 ms
 5  172.16.128.134  10.598 ms  10.651 ms  10.763 ms
 6  172.16.130.2  10.447 ms  10.338 ms  10.462 ms
 7  172.16.127.57  10.143 ms  9.691 ms  9.536 ms
 8  100.64.4.77  10.096 ms * *
 9  172.16.127.5  12.123 ms  11.986 ms  11.972 ms
10  172.16.128.97  21.972 ms  21.855 ms  21.815 ms
11  172.16.128.57  21.764 ms  21.622 ms  22.378 ms
12  172.16.128.185  21.356 ms  21.320 ms  20.755 ms
13  187.16.222.100  116.928 ms  116.149 ms  108.169 ms
14  172.16.4.209  62.086 ms  64.046 ms  61.091 ms
15  * * *
16  * * *
17  172.16.0.253  73.181 ms  74.100 ms  72.987 ms
18  172.16.3.242  75.926 ms  73.956 ms  74.069 ms
19  10.1.45.133  73.971 ms  73.921 ms  75.003 ms
20  200.238.64.52  74.079 ms  73.076 ms  74.005 ms
21  200.238.64.19  74.955 ms  74.967 ms  74.103 ms
22  * * *
23  * * *
24  * * *
25  * * *
26  * * *
27  * * *
28  * * *
29  * * *
30  * * *
```

Mas quando usamos o TCP (porta padrão 80) conseguimos o retorno já no salto 23:

```bash
$ sudo traceroute www.ati.pe.gov.br -T -n
traceroute to www.ati.pe.gov.br (200.238.107.80), 30 hops max, 60 byte packets
 1  192.168.0.1  0.242 ms  0.273 ms  0.330 ms
 2  100.94.128.1  22.020 ms  22.272 ms  22.475 ms
 3  172.16.134.221  11.079 ms  11.073 ms  11.088 ms
 4  172.16.128.49  10.957 ms  10.978 ms  11.007 ms
 5  172.16.128.134  10.499 ms  10.431 ms  11.656 ms
 6  172.16.130.2  11.274 ms  11.243 ms  11.336 ms
 7  172.16.127.57  10.854 ms  9.865 ms  9.821 ms
 8  * * 100.64.4.77  9.706 ms
 9  172.16.127.5  11.720 ms  11.629 ms  11.580 ms
10  172.16.128.97  21.694 ms  22.366 ms  21.414 ms
11  172.16.128.57  21.349 ms  21.099 ms  20.381 ms
12  172.16.128.185  21.337 ms  21.029 ms  20.941 ms
13  187.16.222.100  63.826 ms  63.583 ms  63.135 ms
14  172.16.4.209  64.054 ms  62.107 ms  60.894 ms
15  * * *
16  * * *
17  172.16.0.253  72.099 ms  74.091 ms  72.954 ms
18  172.16.3.242  72.005 ms  73.074 ms  72.982 ms
19  10.1.45.133  72.080 ms  72.006 ms  74.057 ms
20  200.238.64.52  73.101 ms  72.022 ms  71.996 ms
21  200.238.64.18  81.144 ms 200.238.64.19  72.073 ms  74.865 ms
22  200.238.99.10  72.896 ms  74.806 ms  74.072 ms
23  200.238.107.80  72.035 ms  87.017 ms  72.053 ms
```

Por padrão o traceroute utiliza o protocolo UDP, mas ele usa portas altas e varia essas portas no envio de cada pacote. Se utilizarmos o parâmetro "-U" informamos que ele deve usar UDP , mas dessa forma ele fixa a porta "53/UDP", e isso pode fazer diferença.



**Outros materiais**:

- Introdução ao roteamento de pacotes IP - https://youtu.be/y9Vx5l-th9Y
- Curso de Redes - Como funciona o utilitário traceroute - https://youtu.be/2GFZTO0n3Yw
